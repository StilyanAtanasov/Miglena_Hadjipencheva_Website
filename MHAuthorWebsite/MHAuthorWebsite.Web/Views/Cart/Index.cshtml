@using MHAuthorWebsite.Web.ViewModels.Cart
@model CartViewModel

@{
	ViewData["Title"] = "Моята количка";
}

@section Styles {
	<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.3/dist/sweetalert2.min.css" rel="stylesheet">
	<link rel="stylesheet" href="~/css/cart.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/notification.css" asp-append-version="true" />
}

<div class="page-wrapper flex-column">
	<h1 class="title">Моята количка</h1>

	<div class="all-products flex-row">
		<section class="products-sections flex-column">
			@if (Model.Items.Any(i => i.IsAvailable))
			{
				<section id="valid-items-section" class="products-section flex-column" aria-labelledby="valid-items">
					<h2 id="valid-items" class="heading">Избрани продукти</h2>
					<form id="cart-form" method="post" asp-controller="Order" asp-action="Index">
						@Html.AntiForgeryToken()
						<table class="cart-table">
							<thead>
							<tr>
								<th></th>
								<th>Продукт</th>
								<th>Ед. цена</th>
								<th>Количество</th>
								<th>Сума</th>
								<th></th>
							</tr>
							</thead>
							<tbody>
							@foreach (CartItemViewModel item in Model.Items.Where(i => i.IsAvailable))
							{
								<tr class="clickable" data-details-url="@Url.Action("Details", "Product", new { productId = item.ProductId })">
									<td>
										@if (item.IsSelected)
										{
												<input data-role="is-selected-input" data-item-id="@item.ItemId" type="checkbox" name="selectedItems" value="@item.ItemId" checked />
										}
										else
										{
												<input data-role="is-selected-input" data-item-id="@item.ItemId" type="checkbox" name="selectedItems" value="@item.ItemId" />
										}
									</td>
									<td class="product-info flex-row">
										<div class="product-image-container flex-row">
											<img class="product-image" src="@item.ThumbnailUrl" alt="@(item.ThumbnailAlt ?? item.Name)" />
										</div>
										<div class="product-info-general flex-column">
											<h4>
												<a class="link" asp-controller="Product" asp-action="Details" asp-route-id="@item.ProductId">
													@item.Name
												</a>
											</h4>
											<span><strong>Категория: </strong> @item.Category</span>
										</div>
									</td>
									<td><p class="unit-price">@item.UnitPrice.ToString("F2") лв.</p></td>
									<td class="quantity-input">
										<input data-role="quantity-input" class="input" type="number" data-item-id="@item.ItemId" name="Quantities[@item.ItemId]" value="@item.Quantity" min="1" max="10" />
									</td>
									<td id="line-total-@item.ItemId">
										<p>
											<span class="sum-price">@item.LineTotal.ToString("F2")</span>
											<span> лв.</span>
										</p>
									</td>
									<td>
										<button data-role="remove-item" data-item-id="@item.ItemId" class="btn remove btn-none" aria-label="Изтрий">
											<i class="fa-solid fa-trash-can"></i>
										</button>
									</td>
								</tr>
							}
							</tbody>
						</table>
					</form>
				</section>
			}

			<p id="no-products-message" class="flex-row @(Model.Items.Any(i => i.IsAvailable) ? "hidden" : "")"> <i class="fa-regular fa-box-open"></i> Нямате добавени продукти в количката.</p>

			@if (Model.Items.Any(i => i is { IsAvailable: false, IsDiscontinued: false }))
			{
				<section class="products-section flex-column" aria-labelledby="unavailable-items">
					<h2 id="unavailable-items" class="heading">Неналични продукти</h2>
					@foreach (CartItemViewModel item in Model.Items.Where(i => i is { IsAvailable: false, IsDiscontinued: false }))
					{
						<div class="cart-warning flex-row">
							Продуктът „@item.Name“ в момента е изчерпан!
							<button data-role="remove-item" data-item-id="@item.ItemId" class="btn remove btn-none"><i class="fa-solid fa-trash-can"></i></button>
						</div>
					}
				</section>
			}

			@if (Model.Items.Any(i => i.IsDiscontinued))
			{
				<section class="products-section flex-column" aria-labelledby="discontinued-items">
					<h2 id="discontinued-items" class="heading">Спрени продукти</h2>
					@foreach (CartItemViewModel item in Model.Items.Where(i => i.IsDiscontinued))
					{
						<div class="cart-warning flex-row">
							Продуктът „@item.Name“ вече не се предлага!
							<button data-role="remove-item" data-item-id="@item.ItemId" class="btn remove btn-none"><i class="fa-solid fa-trash-can"></i></button>
						</div>
					}
				</section>
			}
		</section>

		<!-- Cart Summary -->
		@if (Model.Items.Any(i => i.IsAvailable))
		{
			<aside id="cart-summary" class="cart-summary flex-column">
				<div class="cart-summary-content flex-column">
					<h2 class="heading">Общо</h2>
					<div class="flex-row">
						<strong>Обща стойност:</strong>
						<p><span id="price-sum">@Model.Total.ToString("F2")</span> <span> лв.</span></p>
					</div>
				</div>
				<button form="cart-form" type="submit" class="btn btn-order order flex-row">
					<i class="fa-solid fa-box-taped"></i> Завърши поръчка
				</button>
			</aside>
		}
	</div>
	
	<form class="hidden">@Html.AntiForgeryToken()</form>
</div>

@section Scripts {
	<script type="module" src="~/js/notification.js" asp-append-version="true"></script>
	<script type="module" src="~/js/cart.js" asp-append-version="true"></script>
	<script src="~/js/click.js" asp-append-version="true"></script>
}